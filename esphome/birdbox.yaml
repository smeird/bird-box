esphome:
  name: esphome-web-e95f34
  friendly_name: Birdbox
  min_version: 2025.11.0
  name_add_mac_suffix: false

substitutions:
  led_count: "5"

web_server:
  version: 3
  port: 80

esp32:
  variant: esp32
  framework:
    type: esp-idf

logger:
api:
ota:
  - platform: esphome

wifi:
  ssid: !secret wifi_ssid
  password: !secret wifi_password

mqtt:
  broker: !secret birdbox_mqtt_host
  username: !secret birdbox_mqtt_user
  password: !secret birdbox_mqtt_pass
  discovery: false
  topic_prefix: Birdbox/1
  on_message:
    - topic: Birdbox/1/switch/pi/set
      then:
        - lambda: |-
            const std::string v = x;
            if (v == "1" || v == "ON" || v == "on" || v == "true") {
              id(pi_power).turn_on();
            } else if (v == "0" || v == "OFF" || v == "off" || v == "false") {
              id(pi_power).turn_off();
            }
    - topic: Birdbox/1/LED/Brightness
      then:
        - lambda: |-
            int value = atoi(x.c_str());
            if (value < 0) value = 0;
            if (value > 255) value = 255;
            id(led_brightness) = value;
        - script.execute: apply_led_state
    - topic: Birdbox/1/LED/R
      then:
        - lambda: |-
            int value = atoi(x.c_str());
            if (value < 0) value = 0;
            if (value > 255) value = 255;
            id(led_r) = value;
        - script.execute: apply_led_state
    - topic: Birdbox/1/LED/G
      then:
        - lambda: |-
            int value = atoi(x.c_str());
            if (value < 0) value = 0;
            if (value > 255) value = 255;
            id(led_g) = value;
        - script.execute: apply_led_state
    - topic: Birdbox/1/LED/B
      then:
        - lambda: |-
            int value = atoi(x.c_str());
            if (value < 0) value = 0;
            if (value > 255) value = 255;
            id(led_b) = value;
        - script.execute: apply_led_state

i2c:
  sda: GPIO21
  scl: GPIO22
  scan: true
  id: bus_a

globals:
  - id: led_brightness
    type: int
    restore_value: false
    initial_value: "0"
  - id: led_r
    type: int
    restore_value: false
    initial_value: "255"
  - id: led_g
    type: int
    restore_value: false
    initial_value: "255"
  - id: led_b
    type: int
    restore_value: false
    initial_value: "255"

script:
  - id: apply_led_state
    mode: queued
    then:
      - lambda: |-
          const int brightness = id(led_brightness);
          if (brightness <= 0) {
            auto call = id(led_strip).turn_off();
            call.perform();
            return;
          }
          auto call = id(led_strip).turn_on();
          call.set_brightness(brightness / 255.0f);
          call.set_rgb(
            id(led_r) / 255.0f,
            id(led_g) / 255.0f,
            id(led_b) / 255.0f
          );
          call.perform();

light:
  - platform: esp32_rmt_led_strip
    rgb_order: GRB
    pin: GPIO18
    num_leds: ${led_count}
    chipset: ws2812
    name: "LED Strip"
    id: led_strip


switch:
  - platform: gpio
    id: pi_power
    name: "Pi Power"
    pin: GPIO16
    restore_mode: ALWAYS_OFF
    on_turn_on:
      then:
        - mqtt.publish:
            topic: Birdbox/1/switch/pi
            payload: "1"
    on_turn_off:
      then:
        - mqtt.publish:
            topic: Birdbox/1/switch/pi
            payload: "0"

  - platform: template
    id: battery_control_enabled
    name: "Battery control enabled"
    restore_mode: RESTORE_DEFAULT_ON
    optimistic: true

number:
  - platform: template
    id: pi_off_pct
    name: "Pi off battery %"
    min_value: 0
    max_value: 100
    step: 1
    mode: slider
    restore_value: true
    initial_value: 20
    optimistic: true

  - platform: template
    id: pi_on_pct
    name: "Pi on battery %"
    min_value: 0
    max_value: 100
    step: 1
    mode: slider
    restore_value: true
    initial_value: 40
    optimistic: true

sensor:
  - platform: lc709203f
    i2c_id: bus_a
    address: 0x0B
    size: 3000
    voltage: 3.7

    battery_voltage:
      name: "Battery Voltage"
      id: batt_v
      on_value:
        then:
          - mqtt.publish:
              topic: Birdbox/1/Battery/Voltage
              payload: !lambda |-
                char buf[16];
                snprintf(buf, sizeof(buf), "%.3f", x);
                return std::string(buf);

    battery_level:
      name: "Battery %"
      id: batt_pct
      on_value:
        then:
          - mqtt.publish:
              topic: Birdbox/1/Battery/Percent
              payload: !lambda |-
                char buf[16];
                snprintf(buf, sizeof(buf), "%.0f", x);
                return std::string(buf);

          - if:
              condition:
                switch.is_on: battery_control_enabled
              then:
                - lambda: |-
                    const float pct = id(batt_pct).state;
                    const float off_th = id(pi_off_pct).state;
                    const float on_th  = id(pi_on_pct).state;
                    if (on_th <= off_th) return;
                    if (id(pi_power).state && pct <= off_th) {
                      id(pi_power).turn_off();
                    } else if (!id(pi_power).state && pct >= on_th) {
                      id(pi_power).turn_on();
                    }
