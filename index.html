<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Birdbox Camera</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 text-gray-800 font-sans">

  <main class="max-w-4xl mx-auto p-6">
    <section class="mb-8">
      <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3 mb-4">
        <h1 class="text-3xl font-bold text-center sm:text-left">Birdbox Camera</h1>
        <div class="flex items-center justify-center sm:justify-start gap-2 bg-white border border-gray-200 text-gray-700 px-3 py-1.5 rounded-full shadow-sm text-xs font-semibold uppercase tracking-wide">
          <span class="text-gray-500">MQTT Status</span>
          <span id="mqtt-status" class="inline-flex items-center px-2 py-0.5 rounded-full bg-gray-100 text-gray-700">Disconnected</span>
        </div>
      </div>
      <div class="bg-gradient-to-r from-sky-50 via-white to-emerald-50 shadow-sm rounded-xl p-6 flex flex-col md:flex-row items-center gap-6">
        <div class="flex items-center gap-4">
          <div class="text-4xl">üê¶</div>
          <div>
            <p class="text-2xl font-bold text-gray-900">Live Birdbox Watch</p>
            <p class="text-sm text-gray-600">Real-time habitat status, power, and motion signals.</p>
          </div>
        </div>
        <div class="flex flex-wrap gap-3 md:ml-auto">
          <div class="flex items-center gap-2 bg-white/80 border border-sky-100 text-gray-800 px-3 py-2 rounded-full shadow-sm">
            <span class="text-xs font-semibold uppercase tracking-wide text-gray-500">Battery</span>
            <span id="battery-charge" class="inline-block bg-green-600 text-white px-2 py-1 rounded-full text-xs">--</span>
          </div>
          <div class="flex items-center gap-2 bg-white/80 border border-blue-100 text-gray-800 px-3 py-2 rounded-full shadow-sm">
            <span class="text-xs font-semibold uppercase tracking-wide text-gray-500">Motion Œî</span>
            <span id="motion-delta" class="inline-block bg-blue-600 text-white px-2 py-1 rounded-full text-xs">--</span>
          </div>
          <div class="flex items-center gap-2 bg-white/80 border border-emerald-100 text-gray-800 px-3 py-2 rounded-full shadow-sm">
            <span class="text-xs font-semibold uppercase tracking-wide text-gray-500">Pi Power</span>
            <span id="pi-power" class="inline-block bg-gray-50 text-gray-700 px-2 py-1 rounded-full text-xs">--</span>
          </div>
        </div>
      </div>
      <div class="bg-white shadow rounded-lg p-6 mt-6">
        <h2 class="text-xl font-semibold mb-4">Status</h2>
        <ul class="divide-y divide-gray-200 text-sm">
          <li class="flex justify-between py-2">
            Last telemetry update
            <span id="last-telemetry-update" class="inline-block bg-gray-100 text-gray-700 px-2 py-1 rounded-full">--</span>
          </li>
          <li class="flex justify-between py-2">
            Battery Voltage
            <span id="battery-voltage" class="inline-block bg-green-600 text-white px-2 py-1 rounded-full">--</span>
          </li>
          <li class="flex justify-between py-2">
            LED Brightness
            <span id="led-brightness" class="inline-block bg-gray-600 text-white px-2 py-1 rounded-full">--</span>
          </li>
          <li class="flex justify-between py-2">
            LED R / G / B
            <span class="inline-block bg-gray-500 text-white px-2 py-1 rounded-full">
              <span id="led-r">--</span> / <span id="led-g">--</span> / <span id="led-b">--</span>
            </span>
          </li>
        </ul>
      </div>
    </section>

    <section>
      <div class="flex flex-wrap items-center justify-between gap-4 mb-4">
        <div>
          <h2 class="text-xl font-semibold">Snapshots</h2>
          <p class="text-sm text-gray-500">Latest capture first with quick actions and archive controls.</p>
        </div>
        <div class="flex flex-wrap items-center gap-3">
          <button id="refresh-snapshots" class="inline-flex items-center gap-2 rounded-full bg-gray-900 text-white px-4 py-2 text-sm font-semibold shadow hover:bg-gray-800 transition">
            Refresh now
          </button>
          <label class="inline-flex items-center gap-2 text-sm text-gray-600 bg-white border border-gray-200 px-3 py-2 rounded-full shadow-sm">
            <input id="auto-refresh-toggle" type="checkbox" class="accent-gray-900" checked />
            Auto refresh
          </label>
          <label class="inline-flex items-center gap-2 text-sm text-gray-600 bg-white border border-gray-200 px-3 py-2 rounded-full shadow-sm">
            Density
            <select id="gallery-density" class="bg-transparent text-sm focus:outline-none">
              <option value="compact">Compact</option>
              <option value="cozy" selected>Cozy</option>
              <option value="roomy">Roomy</option>
            </select>
          </label>
        </div>
      </div>

      <div class="bg-white shadow rounded-2xl p-6 mb-8">
        <div class="flex items-center justify-between gap-4 mb-4">
          <div>
            <h3 class="text-lg font-semibold">Latest snapshot</h3>
            <p id="latest-caption" class="text-sm text-gray-500">Waiting for images...</p>
          </div>
          <span id="latest-updated" class="text-xs uppercase tracking-wide text-gray-400">Last updated --</span>
        </div>
        <div class="rounded-2xl border border-gray-100 bg-gray-50 overflow-hidden">
          <img id="latest-image" src="" alt="Latest snapshot" class="w-full h-auto object-cover max-h-[420px]" />
        </div>
        <div class="flex flex-wrap items-center gap-3 mt-4">
          <button id="latest-view" class="inline-flex items-center gap-2 rounded-full bg-sky-600 text-white px-4 py-2 text-sm font-semibold shadow hover:bg-sky-500 transition">
            View full
          </button>
          <button id="latest-fullscreen" class="inline-flex items-center gap-2 rounded-full border border-gray-200 bg-white px-4 py-2 text-sm font-semibold text-gray-700 shadow-sm hover:bg-gray-50 transition">
            Full screen
          </button>
          <a id="latest-download" href="#" download class="inline-flex items-center gap-2 rounded-full border border-gray-200 bg-white px-4 py-2 text-sm font-semibold text-gray-700 shadow-sm hover:bg-gray-50 transition">
            Download
          </a>
        </div>
      </div>

      <div class="flex items-center justify-between mb-3">
        <h3 class="text-lg font-semibold">Older snapshots</h3>
        <span id="archive-count" class="text-xs uppercase tracking-wide text-gray-400">0 photos</span>
      </div>
      <div id="snapshot-gallery" class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 gap-4"></div>
    </section>
  </main>

  <!-- Modal -->
  <div id="snapshotModal" class="fixed inset-0 bg-black bg-opacity-70 backdrop-blur-sm hidden items-center justify-center z-50">
    <div class="bg-white rounded-2xl shadow-xl p-6 max-w-2xl w-full">
      <div class="flex justify-between items-center mb-4">
        <h3 class="text-lg font-semibold">Snapshot</h3>
        <button onclick="closeModal()" class="text-gray-600 hover:text-black hover:bg-gray-100 rounded-full p-1 text-2xl leading-none">&times;</button>
      </div>
      <div class="text-center">
        <img id="modalImage" src="" alt="Snapshot" class="mx-auto max-h-96 lg:max-h-[70vh] w-auto" />
        <p class="mt-2 text-sm text-gray-500" id="modalTimestamp"></p>
      </div>
    </div>
  </div>

  <!-- Footer -->
  <footer class="text-center text-sm text-gray-500 py-6 mt-12">
    &copy; 2025 Birdbox Camera
  </footer>

  <!-- MQTT.js -->
  <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>

  <!-- Scripts -->
  <script>
    function formatTimestamp(stamp) {
      const match = /(?<y>\d{4})(?<m>\d{2})(?<d>\d{2})_(?<H>\d{2})(?<M>\d{2})(?<S>\d{2})/.exec(stamp);
      if (!match) return stamp;
      const { y, m, d, H, M, S } = match.groups;
      const dateObj = new Date(Number(y), Number(m) - 1, Number(d), Number(H), Number(M), Number(S));
      return dateObj.toLocaleString();
    }

    function setGalleryDensity(value) {
      const gallery = document.getElementById("snapshot-gallery");
      gallery.classList.remove("gap-2", "gap-4", "gap-6");
      if (value === "compact") {
        gallery.classList.add("gap-2");
      } else if (value === "roomy") {
        gallery.classList.add("gap-6");
      } else {
        gallery.classList.add("gap-4");
      }
    }

    async function loadSnapshots() {
      try {
        const res = await fetch("/snapshots/");
        const text = await res.text();
        const doc = new DOMParser().parseFromString(text, "text/html");
        const links = Array.from(doc.querySelectorAll("a"));
        const gallery = document.getElementById("snapshot-gallery");
        gallery.innerHTML = "";

        const jpgLinks = links
          .filter((a) => /\.jpg$/i.test(a.getAttribute("href")))
          .sort((a, b) => (a.getAttribute("href") < b.getAttribute("href") ? 1 : -1));

        const latestImage = document.getElementById("latest-image");
        const latestCaption = document.getElementById("latest-caption");
        const latestUpdated = document.getElementById("latest-updated");
        const latestView = document.getElementById("latest-view");
        const latestFullscreen = document.getElementById("latest-fullscreen");
        const latestDownload = document.getElementById("latest-download");
        const archiveCount = document.getElementById("archive-count");

        if (jpgLinks.length === 0) {
          latestImage.src = "";
          latestCaption.textContent = "Waiting for images...";
          latestUpdated.textContent = "Last updated --";
          latestView.disabled = true;
          latestView.classList.add("opacity-50", "cursor-not-allowed");
          latestFullscreen.disabled = true;
          latestFullscreen.classList.add("opacity-50", "cursor-not-allowed");
          latestDownload.href = "#";
          archiveCount.textContent = "0 photos";
          return;
        }

        const latestLink = jpgLinks[0];
        const latestHref = latestLink.getAttribute("href");
        const latestStamp = latestHref.replace(/\.jpg$/i, "");
        const latestText = formatTimestamp(latestStamp);
        const latestSrc = "/snapshots/" + latestHref;
        latestImage.src = latestSrc;
        latestImage.alt = latestText;
        latestCaption.textContent = latestText;
        latestUpdated.textContent = "Last updated " + new Date().toLocaleTimeString();
        latestView.disabled = false;
        latestView.classList.remove("opacity-50", "cursor-not-allowed");
        latestView.onclick = () => openModal(latestSrc, latestText);
        latestFullscreen.disabled = false;
        latestFullscreen.classList.remove("opacity-50", "cursor-not-allowed");
        latestFullscreen.onclick = () => enterFullScreen(latestImage);
        latestDownload.href = latestSrc;
        latestDownload.setAttribute("download", latestHref);

        const olderLinks = jpgLinks.slice(1);
        archiveCount.textContent = `${olderLinks.length} photos`;

        olderLinks.forEach((link) => {
          const href = link.getAttribute("href");
          const stamp = href.replace(/\.jpg$/i, "");
          const captionText = formatTimestamp(stamp);

          const figure = document.createElement("figure");
          figure.className = "group text-center cursor-pointer bg-white rounded-lg shadow hover:shadow-md transition overflow-hidden";
          const mediaWrapper = document.createElement("div");
          mediaWrapper.className = "relative";
          const img = document.createElement("img");
          img.src = "/snapshots/" + href;
          img.alt = captionText;
          img.className = "w-full h-auto transition-transform duration-200 hover:scale-[1.02]";
          mediaWrapper.appendChild(img);
          const overlay = document.createElement("div");
          overlay.className = "absolute inset-0 flex items-center justify-center bg-black/30 text-white text-sm font-semibold uppercase tracking-wide opacity-0 group-hover:opacity-100 transition";
          overlay.textContent = "View";
          mediaWrapper.appendChild(overlay);
          figure.appendChild(mediaWrapper);

          const caption = document.createElement("figcaption");
          caption.className = "text-xs mt-1 text-gray-600";
          caption.textContent = captionText;
          figure.appendChild(caption);

          figure.addEventListener("click", () => openModal(img.src, captionText));
          gallery.appendChild(figure);
        });
      } catch (err) {
        console.error("Error loading snapshots:", err);
      }
    }

    function openModal(src, caption) {
      document.getElementById("modalImage").src = src;
      document.getElementById("modalTimestamp").textContent = caption;
      document.getElementById("snapshotModal").classList.remove("hidden");
      document.getElementById("snapshotModal").classList.add("flex");
    }

    function enterFullScreen(element) {
      if (!element) {
        return;
      }
      if (element.requestFullscreen) {
        element.requestFullscreen();
      } else if (element.webkitRequestFullscreen) {
        element.webkitRequestFullscreen();
      } else if (element.msRequestFullscreen) {
        element.msRequestFullscreen();
      }
    }

    function closeModal() {
      document.getElementById("snapshotModal").classList.remove("flex");
      document.getElementById("snapshotModal").classList.add("hidden");
    }

    document.addEventListener("DOMContentLoaded", () => {
      const refreshButton = document.getElementById("refresh-snapshots");
      const autoRefreshToggle = document.getElementById("auto-refresh-toggle");
      const densitySelect = document.getElementById("gallery-density");
      let refreshInterval = null;

      const startAutoRefresh = () => {
        if (refreshInterval) {
          clearInterval(refreshInterval);
        }
        refreshInterval = setInterval(loadSnapshots, 10_000);
      };

      const stopAutoRefresh = () => {
        if (refreshInterval) {
          clearInterval(refreshInterval);
          refreshInterval = null;
        }
      };

      refreshButton.addEventListener("click", () => loadSnapshots());
      autoRefreshToggle.addEventListener("change", (event) => {
        if (event.target.checked) {
          startAutoRefresh();
        } else {
          stopAutoRefresh();
        }
      });

      densitySelect.addEventListener("change", (event) => {
        setGalleryDensity(event.target.value);
      });

      setGalleryDensity(densitySelect.value);
      loadSnapshots();
      startAutoRefresh();
    });

    (function initMQTT() {
      const MQTT_BROKER_URL = "wss://mqtt.smeird.com:8083";
      const MQTT_OPTIONS = {
        keepalive: 60,
        clientId: "birdbox_web_" + Math.random().toString(16).slice(2, 10),
        reconnectPeriod: 1_000,
      };
      const client = mqtt.connect(MQTT_BROKER_URL, MQTT_OPTIONS);
      const mqttStatusPill = document.getElementById("mqtt-status");
      const lastTelemetryUpdate = document.getElementById("last-telemetry-update");

      const setMqttStatus = (label, style) => {
        mqttStatusPill.textContent = label;
        mqttStatusPill.classList.remove(
          "bg-gray-100",
          "bg-green-100",
          "bg-amber-100",
          "bg-red-100",
          "text-gray-700",
          "text-green-700",
          "text-amber-700",
          "text-red-700"
        );
        if (style === "connected") {
          mqttStatusPill.classList.add("bg-green-100", "text-green-700");
        } else if (style === "reconnecting") {
          mqttStatusPill.classList.add("bg-amber-100", "text-amber-700");
        } else if (style === "error") {
          mqttStatusPill.classList.add("bg-red-100", "text-red-700");
        } else {
          mqttStatusPill.classList.add("bg-gray-100", "text-gray-700");
        }
      };

      client.on("connect", () => {
        console.log("Connected to MQTT broker");
        setMqttStatus("Connected", "connected");
        client.subscribe([
          "Birdbox/1/Battery/Percent",
          "Birdbox/1/Battery/Voltage",
          "Birdbox/1/LED/Brightness",
          "Birdbox/1/LED/R",
          "Birdbox/1/LED/G",
          "Birdbox/1/LED/B",
          "Birdbox/1/delta",
          "Birdbox/1/switch/pi_power/state"
        ]);
      });

      client.on("reconnect", () => {
        console.log("Reconnecting to MQTT broker");
        setMqttStatus("Reconnecting", "reconnecting");
      });

      client.on("offline", () => {
        console.log("MQTT client offline");
        setMqttStatus("Disconnected", "offline");
      });

      function normalizeSwitchState(value) {
        const normalized = value.trim().toLowerCase();
        if (["1", "on", "true", "yes", "up"].includes(normalized)) {
          return { label: "On", on: true };
        }
        if (["0", "off", "false", "no", "down"].includes(normalized)) {
          return { label: "Off", on: false };
        }
        return { label: value, on: null };
      }

      client.on("message", (topic, payload) => {
        const val = payload.toString();
        lastTelemetryUpdate.textContent = new Date().toLocaleTimeString();
        switch (topic) {
          case "Birdbox/1/Battery/Percent":
            document.getElementById("battery-charge").textContent = val.replace(/%?$/, "") + "%";
            break;
          case "Birdbox/1/Battery/Voltage":
            document.getElementById("battery-voltage").textContent = val + " V";
            break;
          case "Birdbox/1/LED/Brightness":
            document.getElementById("led-brightness").textContent = val;
            break;
          case "Birdbox/1/LED/R":
            document.getElementById("led-r").textContent = val;
            break;
          case "Birdbox/1/LED/G":
            document.getElementById("led-g").textContent = val;
            break;
          case "Birdbox/1/LED/B":
            document.getElementById("led-b").textContent = val;
            break;
          case "Birdbox/1/delta":
            document.getElementById("motion-delta").textContent = val;
            break;
          case "Birdbox/1/switch/pi_power/state": {
            const state = normalizeSwitchState(val);
            const pill = document.getElementById("pi-power");
            pill.textContent = state.label;
            pill.classList.remove(
              "bg-gray-50",
              "bg-green-50",
              "bg-red-50",
              "text-gray-700",
              "text-green-700",
              "text-red-700"
            );
            if (state.on === true) {
              pill.classList.add("bg-green-50", "text-green-700");
            } else if (state.on === false) {
              pill.classList.add("bg-red-50", "text-red-700");
            } else {
              pill.classList.add("bg-gray-50", "text-gray-700");
            }
            break;
          }
        }
      });

      client.on("error", (err) => {
        console.error("MQTT error:", err);
        setMqttStatus("Error", "error");
      });
    })();
  </script>
</body>
</html>
